@model RezervacijaSmjestaja.Models.Rezervacija

@{
    ViewData["Title"] = "Rezervacija smještaja";
    var danasnjiDatum = DateTime.Now.ToString("yyyy-MM-dd");
    bool vecRezervirano = TempData["Greska"] != null;
}

@if (Model.Smjestaj != null)
{
    <div class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card p-3 shadow-lg d-flex flex-column justify-content-between" style="width: 400px;">
            <h2 class="text-center mb-3">Rezervacija</h2>

            @if (vecRezervirano)
            {
                <div class="alert alert-danger text-center">
                    @TempData["Greska"]
                </div>
            }

            <img src="@Model.Smjestaj.SlikaUrl" class="img-fluid rounded mb-3" alt="Slika smještaja">

            <h4 class="text-center">@Model.Smjestaj.Naziv</h4>

            
            <div class="d-flex justify-content-between align-items-center mb-2">
                <p class="text-muted mb-0">@Model.Smjestaj.Opis</p>
                <p class="fw-bold mb-0">@Model.Smjestaj.CijenaPoNoci € / noć</p>
            </div>

            <div class="mb-2">
                <label class="form-label">Datum od</label>
                <input type="date" id="datumOd" class="form-control" required min="@danasnjiDatum" value="@danasnjiDatum" @(vecRezervirano ? "disabled" : "")>
            </div>

            <div class="mb-2">
                <label class="form-label">Datum do</label>
                <input type="date" id="datumDo" class="form-control" required min="@danasnjiDatum" @(vecRezervirano ? "disabled" : "")>
            </div>

            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <p class="fw-bold mb-0">Ukupna cijena: <span id="ukupnaCijena">0</span> €</p>
                <a href="#" onclick="potvrdiRezervaciju(@Model.SmjestajId)" class="btn btn-success @(vecRezervirano ? "disabled" : "")">
                    Potvrdi Rezervaciju
                </a>
            </div>
        </div>
    </div>
}
else
{
    <p class="text-center text-danger">❌ Greška: Smještaj nije pronađen.</p>
}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var datumOd = document.getElementById("datumOd");
        var datumDo = document.getElementById("datumDo");
        var ukupnaCijena = document.getElementById("ukupnaCijena");
        var cijenaPoNoci = parseFloat("@Model.Smjestaj.CijenaPoNoci");

        if (!datumOd || !datumDo) return;

        
        datumDo.setAttribute("min", datumOd.value);

        function izracunajCijenu() {
            var od = new Date(datumOd.value);
            var doDatum = new Date(datumDo.value);

            if (od && doDatum && doDatum > od) {
                var brojNoci = Math.ceil((doDatum - od) / (1000 * 60 * 60 * 24));
                var ukupno = brojNoci * cijenaPoNoci;
                ukupnaCijena.innerText = ukupno >= 0 ? ukupno.toFixed(2) : "0";
            } else {
                ukupnaCijena.innerText = "0";
            }
        }

        datumOd.addEventListener("change", function () {
            datumDo.setAttribute("min", datumOd.value);
            izracunajCijenu();
        });

        datumDo.addEventListener("change", izracunajCijenu);
    });

    function potvrdiRezervaciju(smjestajId) {
        var datumOd = document.getElementById("datumOd").value;
        var datumDo = document.getElementById("datumDo").value;

        if (!datumOd || !datumDo) {
            alert("Molimo odaberite datume!");
            return;
        }

        if (new Date(datumDo) <= new Date(datumOd)) {
            alert("Datum završetka mora biti nakon datuma početka!");
            return;
        }

        window.location.href = `/Rezervacija/PotvrdiRezervaciju?smjestajId=${smjestajId}&datumOd=${datumOd}&datumDo=${datumDo}`;
    }
</script>
